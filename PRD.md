## AI 多图创意编辑器 PRD v0.1（供协同对齐）

### 1. 项目概述
- **产品定位**: 面向非专业设计人员的高效修图与创意合成工具。
- **核心价值**: 通过“圈选 + 多图引用”的简单交互，实现复杂的物体替换、风格迁移和创意合成。
- **技术核心**: 高精度前端交互 + 后端接入 Nano banana2 pro 模型（多图 ControlNet / IP-Adapter 能力）。
- **编辑器形态（最新）**: 上传图片后即成为当前底图，右侧任务列表异步处理，完成后有提示；点击任务可在浮窗中查看生成结果。

### 2. 目标用户与典型场景
- **用户**: 电商运营、短视频创作者、个人爱好者等非专业设计人群。
- **场景**:
  - 把图1的猫放到图2的桌子上（内容迁移）。
  - 让底图天空变成油画风（风格迁移）。
  - 消除路人并自然补全背景（Inpainting）。

### 3. 核心界面布局（UI Layout）
- **三栏式**: `左：编辑器与上传` | `中：主画布` | `右：任务列表 + 属性与绑定`。
- **左侧（编辑器与上传）**:
  - 支持拖拽/点击上传；第一张图自动设为当前底图。
  - 可选择预处理标记（如：仅前景）。
- **中间（主画布）**:
  - 支持缩放、平移；图层简化为：底图层 + 蒙版层。
  - 绘制蒙版时具备平滑与闭合补全、几何修正；磁性吸附集成 SAM（后续）。
- **右侧（任务列表 + 属性与绑定）**:
  - 任务列表显示状态与完成提示；可点击打开浮窗预览生成结果。
  - 属性与绑定用于配置控制模式（content/style/structure）、强度、补充提示词等参数。

### 4. 详细功能模块（Functional Requirements）
- 模块一：素材管理与预处理（Reference System）
  - 多图上传并生成唯一 ID（`ref_001`、`ref_002`）。
  - 智能预处理（Auto-Segment）：“仅前景”标记；前端接入 SAM 进行主体提取，减少干扰信息。
- 模块二：智能绘图与蒙版系统（Drawing System）
  - 画笔轨迹修正：实时平滑（Streamline / Lazy Mouse），过滤手抖；近闭合自动吸附闭合。
  - 磁性吸附：集成 SAM 点击/框选；hover 高亮底图物体轮廓，点击生成贴边蒙版。
  - 几何修正：烂框自动修正为标准矩形、圆形或直线，提升结构理解。
- 模块三：多图绑定与逻辑映射（Logic Layer）
  - 蒙版-素材绑定：选中蒙版，点击素材图进行绑定，显示连线或缩略图反馈。
  - 控制模式：
    - Content（内容迁移）：把图1的东西搬到蒙版区域。
    - Style（风格迁移）：保持底图结构，只迁移图2颜色/材质。
    - Structure（结构迁移）：保持底图颜色，用参考图形状（保留但少用）。
  - 强度（0-1）与文字补充（prompt_suffix）。
- 模块四：消除与修补（Inpainting & Clean up）
  - 橡皮擦模式：蒙版标记为 `Remove_Area`；根据周围像素进行 Inpainting 补全。
  - 背景结构线重绘：可在空白处画结构线作为“几何提示”，模型据此生成背景。

### 5. 数据交互协议（API JSON Structure）
- **请求示例**:
```json
{
  "project_id": "12345",
  "base_image": "base64_string_or_url",
  "reference_assets": [
    { "id": "ref_001", "image": "url_to_image_1", "preprocess": "foreground_only" },
    { "id": "ref_002", "image": "url_to_image_2", "preprocess": "none" }
  ],
  "mask_regions": [
    {
      "mask_data": "base64_mask_A",
      "action": "generation",
      "reference_link": "ref_001",
      "control_mode": "content",
      "strength": 1.0,
      "prompt_suffix": "sitting on the table"
    },
    {
      "mask_data": "base64_mask_B",
      "action": "style_transfer",
      "reference_link": "ref_002",
      "control_mode": "style",
      "strength": 0.6
    },
    {
      "mask_data": "base64_mask_C",
      "action": "remove",
      "reference_link": null
    }
  ],
  "global_params": { "output_resolution": "1024x1024", "seed": 42 }
}
```
- **字段说明**:
  - `base_image`: 当前编辑的底图（上传后即生效）。
  - `reference_assets`: 参考素材列表；`preprocess` 可设 `foreground_only`。
  - `mask_regions`: 蒙版与指令集合；每个区域包含 `action`、`reference_link`、`control_mode`、`strength`、`prompt_suffix`。
  - `global_params`: 全局生成参数（分辨率、随机种子等）。

### 6. 异步任务与并行操作（任务列表）
- **提交任务**: 在右侧“属性与绑定”设置参数后，提交生成任务进入队列。
- **任务状态**: `PENDING` → `PROCESSING` → `COMPLETE` / `FAILED`。
- **进度与提示**: 处理期间可继续其他操作；任务完成弹出提示；在任务列表中点击“查看”打开浮窗展示结果（支持多任务查看）。
- **浮窗预览**: 展示生成结果；后续可支持“对比模式”（按住看原图）。
- **通信方式**: WebSocket（优先）或轮询（回退）。

### 7. 技术架构
- **前端**: React + TypeScript + Vite；Konva.js 画布；Zustand 状态管理；onnxruntime-web（WebGPU 优先，WASM 回退）+ WebWorker（SAM 推理）。
- **后端代理**: Node.js + Fastify / Express：
  - 职责：鉴权与API转发、任务队列与进度、结果回传，不持久化用户素材。
  - 安全：使用环境变量 `NANO_API_KEY`；前端绝不包含密钥。
- **模型接口**: Nano banana2 pro；参考文档：[API 文档](https://docs.apimart.ai/en/api-reference/images/gemini-3-pro/generation)。

### 8. 开发路线图（里程碑与启动验证）
- **里程碑 A（第1周）**: 项目骨架与三栏布局，上传即编辑底图；启动验证：本地可运行、交互可用。
- **里程碑 B（第2周）**: 画布交互完善：平滑笔刷、闭合补全、几何修正；启动验证：蒙版绘制流畅。
- **里程碑 C（第3周）**: 素材管理与预处理、SAM 前端集成；启动验证：点击/框选生成贴边蒙版。
- **里程碑 D（第4周）**: 蒙版-素材绑定与控制模式；启动验证：参数配置与持久化生效。
- **里程碑 E（第5周）**: 后端代理与模型联调；任务列表与进度；启动验证：全流程生成与浮窗预览。
- **里程碑 F（第6-7周）**: 消除与修补、性能优化、测试与部署；启动验证：消除自然度与可用性达标。

### 9. 验收标准
- 上传图片即成为当前底图；画布按底图尺寸初始化，缩放/平移流畅。
- 可绘制平滑、闭合的蒙版；几何修正有效；SAM 点击/框选贴边蒙版。
- 蒙版与参考素材绑定逻辑生效；三种控制模式与强度可配置。
- 异步任务队列可用；完成提示与浮窗预览正常；可同时处理多任务。
- 前端不包含密钥；后端代理稳定；错误与重试机制健全。

### 10. 性能与兼容性
- 前端优先 WebGPU；回退 WASM；限制最大分辨率以避免 OOM。
- 大图处理采用缩略预览与分块策略；确保交互流畅。

### 11. 风险与对策
- **推理延迟**: 队列与进度条、取消/重试；任务列表并行管理。
- **边缘假象**: 对“消除”类蒙版自动 padding 10–20 像素，提升背景修补自然度。
- **位置敏感**: 蒙版尺寸必须与底图严格 1:1，对齐校验。

### 12. 规范与注意事项（必须遵循）
- **笔触转矢量路径存储**: 前端将笔触转为 `SVG Path` 等矢量格式存储，再栅格化为 Mask 图传给模型，保证边缘平滑与可编辑。
- **蒙版尺寸严格 1:1**: 生成的 Mask 必须与底图尺寸严格对应，禁止任何缩放。
- **消除蒙版扩边**: 在物体消除操作中，自动向外扩展 10–20 像素边界，为模型提供背景纹理信息。

### 13. 待确认问题（请共同补充）
- 控制模式与模型具体参数映射的规范（API tag 对应关系）。
- 任务并行度与最大队列长度、取消/重试的边界策略。
- SAM 使用方式：前端 ONNX 推理 vs 服务端 API；性能与兼容性考量。
- 全局参数的扩展（如 CFG、步数、噪声调度等），是否对用户暴露。
- 结果对比模式的交互细节（按住看原图 vs 左右滑对比）。

### 14. 术语表
- **Content**: 内容迁移，将参考图中的目标搬入蒙版区域。
- **Style**: 风格迁移，保持结构，仅迁移颜色/材质。
- **Structure**: 结构迁移，保持底图颜色，仅迁移形状。
- **Inpainting**: 基于周边像素的补全与修补。
- **SAM**: Segment Anything Model，用于自动分割与选区辅助。

备注：本 PRD 用于我们双方对齐交互与技术细节，后续迭代将以此为基线更新。
