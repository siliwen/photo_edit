# 坐标标记实现方案交付说明

## 目标与范围

- 在不依赖颜色标记的前提下，通过坐标标签在提示词中精准定位多处修改区域，使模型明确“在何处做什么”，并可选地“用哪张参考图”。
- 保持现有数据流与接口稳定，新增坐标标记的解析与重组，不影响原有蒙版流程与日志体系。

## 使用方法

- 在“效果描述与模型选择”卡片的输入框中输入坐标标签：
  - `@rect(x,y,w,h) 说明文本`
  - `@circle(cx,cy,r) 说明文本`
  - `@point(x,y) 说明文本`
  - `@poly(x1,y1;x2,y2;...;xn,yn) 说明文本`
- 也可以在智能提示面板中一键插入来自已绘制元素的坐标标签：
  - “矩形/圆形/画笔元素”均可生成对应的 `@rect/@circle` 标签，数值来自元素的包围盒与半径计算。

## 前端改动

- 文件：`web/src/components/cards/PromptAndModelCard.tsx`
  - 新增坐标工具：在 @ 智能面板中按元素逐条展示，支持插入 `@rect/@circle` 标签。
  - 位置：`web/src/components/cards/PromptAndModelCard.tsx:237-286` 区域被替换为坐标对象列表及插入逻辑。
- 构建验证：
  - `npm run build` 已通过；类型检查由 `tsc -b` 执行。

## 后端改动

- 文件：`server/index.js`
  - 解析坐标标签：`parseCoordinateTags`（支持 `@rect/@circle/@point/@poly`）。
  - 重组提示词：在 `buildStructuredPrompt` 中追加 `[COORDINATE REGIONS]` 段，逐条列出区域与操作意图，并保留白/黑蒙版的边界约束说明。
  - 位置：`server/index.js:386-423`（解析）、`server/index.js:425-433`（清理与日志）、`server/index.js:33-46`（结构化段集成）。
  - 日志：维持原有 `request/ai_request/ai_submit_response/ai_poll_*` 记录。

## 提交到模型的完整结构（摘要）

- 字段保持不变：`model/size/resolution/n/image_urls/mask_url/prompt`。
- 新的提示词结构（示例）：
  - `[USER REQUIREMENTS]` 主体语义（去除坐标标签后残留）
  - `[COORDINATE REGIONS]` 多条区域说明：
    - `- Region 1: rectangle at 120,80,200x100 -> Replace the bird with an owl, use image 2 as reference`
    - `- Region 2: circle at 600,400,r=90 -> Remove the object`
  - 如有蒙版：保留 `[MASK REGIONS - CRITICAL INSTRUCTIONS]` 的白/黑约束段，强化边界遵循。

## 自测与对比计划

- 用例 A：只用坐标标签，不传蒙版。验证区域定位与操作生效。
- 用例 B：二值蒙版（多白区）+ 坐标标签。验证协同下的准确性与一致性。
- 用例 C：复杂多区域，单次提交 vs 逐次提交（每次只处理一个区域，上一次输出作为下一次主图）。对比成功率与可控性。
- 监控点：
  - 后端日志中的 `coordRegions` 与结构化提示词段落是否正确。
  - API 返回的任务状态与结果图片 URL。

## 迁移路线与回滚

- 阶段 1：增量引入坐标标签解析与提示词重组，保留蒙版流程。
- 阶段 2：在复杂场景中优先使用“坐标 + 逐次任务”策略，提升精准度。
- 阶段 3：验证通过后逐步替换色彩分组依赖，蒙版作为边界兜底。
- 回滚方案：随时禁用坐标解析入口，恢复仅蒙版与颜色分组的提示词构造；日志与接口保持兼容。

## 注意事项与最佳实践

- 坐标系与尺寸：坐标与宽高应与主图像素尺寸一致，避免缩放误差。
- 指令用语：以动词开头，明确操作与参考图映射（如 `use image K as reference`）。
- 多区域协作：复杂场景建议逐次执行，减少区域间互相影响与语义冲突。
- 性能与稳定性：本改动仅增强 `prompt` 文本结构，不改变接口字段与请求体大小，性能影响可忽略。

## 运行与验证

 - 前端：`cd web && npm install && npm run dev`
 - 后端：`cd server && npm install && PORT=3002 npm run dev`
 - 提交任务后查看 `server/logs` 日志，对比坐标段与最终结果。

## 代码参考索引

- 后端结构化提示词入口：`server/index.js:37`（`buildStructuredPrompt`）
- 坐标解析：`server/index.js:386`（`parseCoordinateTags`）
- 前端坐标插入 UI：`web/src/components/cards/PromptAndModelCard.tsx:196-234`
