# AI 多图创意编辑器

## 当前进度总结

### ✅ 已完成的核心功能

-#### 前端编辑器 (100%)
- **主图编辑器**: 上传、缩放、平移、标注坐标绘制
- **图片编辑工具**： 
  - ✅ **裁剪功能**（矩形选区、比例约束、裁剪后替换原图）
  - ✅ **旋转/翻转功能**（顺时针90°、水平/垂直翻转）
- **标注系统**: 
  - 标注模式: 画笔/矩形/圆形
  - ✅ **矩形工具保存修复** - 支持2点保存
  - 笔触平滑算法(滑动窗口)
  - 闭合自动吸附(<20px)
  - 笔刷粗细调整(5-50px)
  - 标注可见性切换
  - 点击标注选中(橙色高亮)
  - ✅ **实时几何形状预览** - 矩形/圆形绘制时实时显示
- **参考图管理**: 多图上传、编号系统、悬停预览
- **全局参数**: 提示词、模型选择、输出分辨率(4K自动计算)

#### 后端代理 (100%)
- **API 服务**: Fastify + CORS + WebSocket
- **任务管理**: 提交、查询、状态更新
- **Nano banana2 pro 对接**: 请求组装、异步处理
- **环境配置**: API Key 安全管理

#### 数据流程 (100%)
- **完整 Payload**: base_image、reference_assets、global_params、prompt（含坐标标签）
- **异步任务**: PENDING → PROCESSING → COMPLETE/FAILED
- **前端轮询**: 2秒间隔查询任务状态
- **结果预览**: 浮窗展示生成结果

### 🚧 待开发功能

#### Phase 3: 蒙版功能增强（规划中）
- 📝 **多工具支持**
  - 矩形选区工具（✅ 已完成）
  - 圆形选区工具
  - 自由绘制工具（笔刷）
- 📝 **颜色标记系统**（重点优化）
  - 支持多颜色蒙版绘制（红、蓝、绿等）
  - 将多个颜色蒙版合成一张RGB图
  - 通过颜色通道区分不同蒙版区域
  - 提示词中自动关联颜色和操作
- 📝 **智能引用体验**
  - @ 触发显示颜色标记（如“红色矩形区域”）
  - # 触发显示蒙版编号+颜色+形状
  - 自动生成结构化描述
- 📝 **蒙版编辑功能**
  - 修改已有蒙版
  - 拖拽调整位置
  - 缩放调整大小
- 📝 **交互优化**
  - 撤销/重做功能
  - 快捷键支持
  - 蒙版预览优化

#### 智能选区增强
- SAM 磁性吸附: 点击/框选生成贴边蒙版
- 几何修正: 自动识别矩形/圆形/直线
- 前景预处理: SAM 前景提取

#### 性能优化
- WebWorker: SAM 模型推理
- WebGPU/WASM: onnxruntime-web 加速
- 内存管理: 大图分辨率控制

#### 用户体验
- 任务取消/重试
- 结果对比模式(按住看原图)
- 错误提示优化
- 操作撤销/重做

---

# 使用指南（更新说明）

### 近期更新摘要
- @ 智能面板支持从画布元素插入坐标与形状标签（`@rect`/`@circle`/`@矩形一` 等）。
- 提交接口端口统一为 `http://localhost:3001`（与后端服务保持一致）。
- `@颜色` 引用支持容错（`color` 可选）；推荐优先使用坐标或形状标签描述局部修改。

### 1. 上传主图
在"原始图片"卡片中点击"选择图片"，上传要编辑的底图。

### 2. 绘制标注
- 选择绘制工具:
  - **🖌️ 自由绘制**: 手绘任意形状
  - **■ 矩形工具**: 点击起点拖动到对角，实时预览
  - **● 圆形工具**: 点击圆心向外拖动，实时预览
  - **🧹 消除模式**: 圈选要消除的区域
- 调整笔刷粗细（5-50px）
- 选择标注颜色（仅用于可视化）
- 自由绘制时终点靠近起点(<20px)会自动闭合
 - 标注完成后自动保存到“标注对象”列表
 - 在列表中可删除标注对象

### 2.5 裁剪原图（✅ 新增）
- 点击“✂️ 裁剪”按钮进入裁剪模式
- 选择裁剪比例：
  - **自由比侏**: 任意大小拖拽
  - **1:1 正方形**: 自动保持正方形比例
  - **16:9 宽屏**: 适合视频/屏幕
  - **4:3 传统**: 传统照片比例
- 鼠标拖拽选择裁剪区域，画布实时显示绿色裁剪框
- 松开鼠标后显示尺寸信息，点击“✔️ 确认裁剪”按钮
- 裁剪后：
  - 原图自动替换为裁剪后的图片
  - 所有坐标标注被清空（因为坐标已失效）
  - 图片元数据自动更新

### 2.6 旋转/翻转原图（✅ 新增）
- 点击“↻ 旋转/翻转”按钮展开下拉菜单
- 支持三种变换操作：
  - **↻ 顺时针90°**: 图片顺时针旋转90度，宽高互换
  - **⇄ 水平翻转**: 左右镜像翻转
  - **⇕ 垂直翻转**: 上下镜像翻转
- 变换后：
  - 原图自动替换为变换后的图片
  - 所有坐标标注被清空（因为坐标已失效）
  - 图片元数据自动更新

### 3. 消除模式
- 点击"消除模式"按钮
- 圈选要消除的物体
- 系统会自动扩边10-20px以提供背景纹理信息
 - 标注完成后可在提示词中描述“移除该区域对象”

### 4. 添加参考图
在"参考图片"卡片中上传素材图：
- 支持多图上传
- 每张图自动生成编号（ref_001, ref_002...）
- 鼠标悬停可预览大图

### 5. 标注坐标与提示词
在“效果描述”中结合坐标标签描述局部修改：
 - 使用 `@rect(x,y,w,h)` 或 `@circle(cx,cy,r)`
 - 引用参考素材 `@ref_xxx` 指定风格或内容来源

### 6. 智能提示词编写
在"效果描述"输入框中：
- 输入 **@** 自动弹出选择菜单
- 可选择参考素材 `@ref_xxx` 或坐标对象并插入 `@rect/@circle`
- 示例: `@rect(120,60,200,100) 将该区域替换为草地`

### 6. 智能提示词编写
在"效果描述"输入框中：
- 输入 **@** 自动弹出素材选择菜单
- 示例: "将 @ref_001 的猫放在 @rect(100,200,320,180) 的位置"

### 7. 填写提示词并提交
- 在"效果描述与模型"卡片中输入全局提示词
- 选择模型（默认 banana2-pro）
- 点击底部"提交生成"按钮

### 8. 查看结果
- 右侧任务列表实时显示任务状态
- 任务完成后点击"查看"按钮
- 在浮窗中预览生成结果

## 快速启动

### 前端
```bash
cd web
npm install
npm run dev
# 访问 http://localhost:5179 （端口可能自动调整）
```

### 后端
```bash
cd server
# 如无 .env.example，可直接创建并按下方“环境配置说明”填写
npm install
npm run dev
# 服务运行在 http://localhost:3001
```

### 生产预览
```bash
cd web
npm run build && npm run preview
# 访问 http://localhost:4173/
```

### 环境配置说明

编辑 `server/.env` 文件，配置以下环境变量：

```bash
# Nano banana2 API 配置（必填）
NANO_API_KEY=your_api_key_here  # 从 https://apimart.ai 获取
NANO_API_BASE=https://api.apimart.ai

# 阿里云 OSS 配置（必填）
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com  # OSS 区域 endpoint
OSS_AK=your_access_key_id  # 阿里云 AccessKeyId
OSS_SK=your_access_key_secret  # 阿里云 AccessKeySecret
OSS_BUCKET=your_bucket_name  # OSS Bucket 名称
OSS_PUBLIC_DOMAIN=https://your-bucket.oss-cn-hangzhou.aliyuncs.com  # OSS 公开访问域名
OSS_ROOT_PREFIX=test  # 文件存储路径前缀

# 服务端口（可选）
PORT=3001
```

**重要说明：**
- 本项目使用**对象存储URL方式**传输图像，需配置阿里云OSS
- 如需使用其他对象存储（腾讯COS/七牛云），需修改 `server/index.js` 中的上传逻辑
- Bucket 必须设置为**公共读**权限，否则 API 无法访问图片

## 功能特性

### 已实现
- ✅ 双区域卡片式布局（编辑区 + 任务列表）
- ✅ 主图上传与蒙版绘制（模式切换：查看/绘制蒙版/消除模式）
- ✅ 多种蒙版绘制方式：
  - 🖌️ 自由绘制（平滑笔触）
  - ■ 矩形工具
  - ● 圆形工具
  - 🧹 消除模式
- ✅ 蒙版颜色标记（自定义颜色选择器）
- ✅ 蒙版文字标签（可为每个蒙版添加文字说明）
- ✅ 笔触平滑算法（滑动窗口平均）
- ✅ 闭合自动吸附（终点距起点<20px自动闭合）
- ✅ 笔刷粗细调整（5-50px）
- ✅ 消除模式自动扩边（10-20px）
- ✅ 蒙版可见性切换（显示/隐藏）
- ✅ 蒙版列表管理（选中、编辑、删除）
- ✅ 蒙版与素材绑定面板
  - 动作类型：内容生成/风格迁移/物体消除
  - 绑定参考图（引用素材ID）
  - 控制模式：Content/Style/Structure
  - 强度滑块（0-1）
  - 补充提示词
- ✅ 参考图素材管理
  - 多图上传
  - 悬停预览
  - 编号引用
  - 删除功能
- ✅ 智能提示词输入
  - 输入 @ 自动弹出素材选择
  - 输入 # 自动弹出蒙版选择
  - 点击即可插入引用
- ✅ 输出分辨率控制（默认4K，按主图比例自动计算）
- ✅ 任务提交与异步轮询
- ✅ 后端服务稳定性
  - API 503错误重试机制（最多3次）
  - 请求超时控制（30s）
  - 指数退避重试
- ✅ 后端代理服务与 Nano banana2 pro API 对接
- ✅ 结果浮窗预览

### 开发中
- 🚧 SAM 磁性吸附（智能选区：点击/框选生成贴边蒙版）
- 🚧 几何修正（自动识别矩形/圆形/直线）
- 🚧 前景预处理(SAM前景提取)

## 功能演示

### 场景 1: 内容迁移 - 把猫放到桌子上
1. 上传桌子图片作为主图
2. 上传猫咪图片作为参考图(ref_001)
3. 在桌子上绘制蒙版(圈出想要放猫的位置)
4. 在蒙版绑定面板中:
   - 动作类型: 内容生成
   - 绑定参考图: ref_001
   - 控制模式: Content
   - 强度: 1.0
   - 补充提示词: "sitting on the table"
5. 提交生成

### 场景 2: 风格迁移 - 让天空变成油画风
1. 上传风景照作为主图
2. 上传油画天空素材作为参考图(ref_001)
3. 在天空区域绘制蒙版
4. 在蒙版绑定面板中:
   - 动作类型: 风格迁移
   - 绑定参考图: ref_001
   - 控制模式: Style
   - 强度: 0.7
5. 提交生成

### 场景 3: 物体消除 - 移除路人
1. 上传含有路人的照片作为主图
2. 点击"消除模式"按钮
3. 圈选要移除的路人(系统自动扩边10-20px)
4. 点击"保存"
5. 蒙版自动设为"物体消除"动作
6. 提交生成

### 多蒙版组合场景
可以在同一张图上绘制多个蒙版,实现复杂编辑:
- 蒙版 A: 消除路人
- 蒙版 B: 在桌子上添加猫咪(ref_001, Content)
- 蒙版 C: 天空变成油画风(ref_002, Style)

## 技术栈

### 前端
- React + TypeScript + Vite
- Konva.js (图像编辑与蒙版绘制)
- Zustand (状态管理)

### 后端
- Fastify + Node.js
- Nano banana2 pro API (中转站)
- WebSocket (进度推送)

## 数据结构

### AnnotationElement
```typescript
{
  id: string
  name?: string
  type: 'brush' | 'rectangle' | 'circle'
  points: Array<{ x: number; y: number }>
  brushSize: number
}
```

### ReferenceAsset
```typescript
{
  id: string
  url: string
  preprocess: 'none' | 'foreground_only'
}
```

## API 接口

### POST /api/submit
提交生成任务（基于坐标标注的提示词）
```json
{
  "base_image": "https://.../main.jpg",
  "reference_assets": [
    { "id": "ref_001", "url": "https://.../cat.jpg" }
  ],
  "global_params": { "output_resolution": "3840x2160" },
  "prompt": "保持主体不变，将 @rect(100,120,240,160) 区域替换为草地；参考 @ref_001 的风格"
}
```

### GET /api/task/:taskId
查询任务状态
```json
{
  "id": "job_1234567890",
  "status": "COMPLETE",
  "result": "https://...",
  "error": null
}
```

### POST /api/upload
上传文件（后端会存储到对象存储并返回公开 URL）
```
Content-Type: multipart/form-data
file: <binary>
```

## 集成与测试指引

- 端口统一：后端 `http://localhost:3001`，前端开发端口由 Vite 自动分配（通常 `5173`）；生产预览端口为 `4173`。
- 正式联调：不设置 `NANO_MOCK`，并确保 `NANO_API_KEY` 与对象存储配置有效。
- 建议流程：
- 上传主图与参考素材到 OSS；在前端填写对应 URL。
- 使用坐标标签在 `prompt` 中明确局部修改区域，如 `@rect(...)` 或 `@circle(...)`。
- 推荐统一使用坐标标注；不再使用颜色语义标注。
  - 提交后在任务列表观察 `PENDING/PROCESSING/COMPLETE` 状态，完成后预览结果 URL。

## 安全与配置

- 请勿在仓库中提交真实密钥；仅在本地 `.env` 配置。
- `.env` 示例字段：`NANO_API_KEY`、`NANO_API_BASE`、`OSS_ENDPOINT`、`OSS_AK`、`OSS_SK`、`OSS_BUCKET`、`OSS_PUBLIC_DOMAIN`、`PORT`。
- 对象存储需开启公共读访问，否则上游 API 无法访问图片。
